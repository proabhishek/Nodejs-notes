'use strict';

const config = require('./config');
const mandrill = require('mandrill-api/mandrill');
const mandrill_client = new mandrill.Mandrill(config.mandrillApiKey);

const arrayFromObject = (content) => {
  const val = [];
  for (const key in content) {
    val.push({ name: key, content: content[key] })
  }
  return val;
};

const emailContent = {
  username: 'Rizek User'
  // password: 'mypassword'
};

const sendEmail = async (emailContent, targetEmailAddress) => {
  const message = {
    'subject': 'Welcome To Rizek',
    'from_email': 'no-reply@rizek.com',
    'from_name': 'Rizek',
    'to': [{
      'email': 'abhishek@think42labs.com',
      'type': 'to'
    }],
    'merge_language': 'handlebars',
    'headers': {
      'Reply-To': 'no-reply@rizek.com'
    },
    'global_merge_vars': arrayFromObject(emailContent)
  };

  const template = {
    template_name: 'when-user-is-registered-on-the-rizek-app',
    template_content: [],
    message: message,
    async: false,
    ip_pool: 'Main Pool'
  };

  return new Promise((resolve, reject) => {
    mandrill_client.messages.sendTemplate(template, (result) => {
      resolve(result)
    }, (e) => {
      console.error(e);
      reject(e)
    });
  });
};

sendEmail(emailContent, 'theabhishek.srm@gmail.com')
  .then((result) => console.log(result))
  .catch((error) => console.log("Cannot send the email, error:" + error));
